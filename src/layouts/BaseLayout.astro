---
import '../styles/global.css';
import { getSettings } from '../lib/content';
import { THEME_PALETTES, type ThemeMode } from '../lib/types';
import InstallPrompt from '../components/InstallPrompt.astro';
import OnboardingCarousel from '../components/OnboardingCarousel.astro';
import GoogleReviewPrompt from '../components/GoogleReviewPrompt.astro';

interface Props {
  title?: string;
  description?: string;
  showNav?: boolean;
}

const { title, description, showNav = true } = Astro.props;

const settings = await getSettings();

// Normalize hex color (add # if missing)
function normalizeColor(color: string | undefined): string | undefined {
  if (!color) return undefined;
  const trimmed = color.trim();
  if (trimmed.startsWith('#')) return trimmed;
  // Check if it looks like a hex color (3, 6, or 8 hex chars)
  if (/^[0-9a-fA-F]{3,8}$/.test(trimmed)) return `#${trimmed}`;
  return trimmed;
}

// Determine theme (default: dark)
const themeMode: ThemeMode = settings.theme || 'dark';
const palette = THEME_PALETTES[themeMode];

// Custom colors if defined, otherwise use palette defaults
const customPrimary = normalizeColor(settings.primaryColor);
const customAccent = normalizeColor(settings.accentColor);

const primaryColor = customPrimary || palette.accent;
const primaryDark = customPrimary
  ? `color-mix(in srgb, ${customPrimary} 80%, black)`
  : palette.accentDark;
const primaryGlow = customPrimary
  ? `${customPrimary}4d`
  : palette.accentGlow;
const accentColor = customAccent || palette.accent;

const pageTitle = title
  ? `${title} | ${settings.hostelName}`
  : settings.hostelName;

const pageDescription = description || `Welcome to ${settings.hostelName} - Your digital guide`;

// Theme color for status bar (matches background)
const themeColor = palette.bg;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content={pageDescription} />

    <!-- Theme color for BLACK theme -->
    <meta name="theme-color" content={themeColor} />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content={settings.hostelName} />

    <link rel="icon" type="image/png" href={settings.favicon || "/favicon.png"} />
    <link rel="apple-touch-icon" href={settings.pwaIcon192 || "/images/icon-192.png"} />

    <link rel="manifest" href="/manifest.json" />

    <!-- Google Fonts: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet" />

    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <title>{pageTitle}</title>

    <!-- Dynamic theme colors from settings.json -->
    <style set:html={`
      :root {
        --color-primary: ${primaryColor};
        --color-primary-dark: ${primaryDark};
        --color-accent: ${accentColor};
        --color-primary-glow: ${primaryGlow};

        --color-bg: ${palette.bg};
        --color-surface: ${palette.surface};
        --color-surface-input: ${palette.surfaceInput};
        --color-surface-subtle: ${palette.surfaceSubtle};
        --color-surface-hover: ${palette.surfaceHover};

        --color-text: ${palette.text};
        --color-text-secondary: ${palette.textSecondary};
        --color-text-muted: ${palette.textMuted};
        --color-muted: ${palette.muted};

        --color-border: ${palette.border};
        --color-border-light: ${palette.borderLight};
        --color-separator: ${palette.separator};
      }
    `}></style>
  </head>

  <body class="min-h-screen antialiased overflow-x-hidden">
    <a
      href="#main"
      class="sr-only sr-only-focusable fixed top-4 left-4 z-50 bg-primary px-4 py-2 rounded-lg"
      style="color: var(--color-bg);"
    >
      Skip to main content
    </a>

    <main id="main">
      <slot />
    </main>

    <!-- Onboarding Carousel -->
    <OnboardingCarousel />

    <!-- Google Review Prompt -->
    <GoogleReviewPrompt />

    <!-- PWA Install Prompt -->
    <InstallPrompt />

    {showNav && (
      <nav data-tour="nav" class="bottom-nav">
        <a href="/" class="nav-item" data-page="home">
          <span class="material-symbols-outlined">home</span>
        </a>
        <a href="/explore" class="nav-item" data-page="explore" data-tour="nav-explore">
          <span class="material-symbols-outlined">menu_book</span>
        </a>
        <!-- WhatsApp FAB - Central Action Button -->
        <a
          href={`https://wa.me/${(settings.contacts?.whatsapp || settings.whatsapp || '').replace(/[^0-9]/g, '')}?text=${encodeURIComponent(`Hi, I'm staying at ${settings.hostelName} and I have a question...`)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="nav-fab"
          aria-label="Contact us on WhatsApp"
        >
          <svg viewBox="0 0 24 24" fill="currentColor" class="whatsapp-icon">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
        </a>
        <a href="/services" class="nav-item" data-page="services" data-tour="nav-services">
          <span class="material-symbols-outlined">concierge</span>
        </a>
        <a href="/info" class="nav-item" data-page="info">
          <span class="material-symbols-outlined">info_i</span>
        </a>
      </nav>
    )}

    <script>
      // Highlight active nav item based on current path
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.nav-item');

      navItems.forEach(item => {
        const href = item.getAttribute('href');
        const isActive = href === '/'
          ? currentPath === '/'
          : currentPath.startsWith(href || '');

        if (isActive) {
          item.classList.add('active');
          const icon = item.querySelector('.material-symbols-outlined');
          if (icon) icon.classList.add('filled');
        }
      });
    </script>

    <style>
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        display: flex;
        justify-content: space-around;
        align-items: center;
        height: var(--bottom-nav-height);
        background-color: color-mix(in srgb, var(--color-bg) 95%, transparent);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid var(--color-border);
        padding-bottom: env(safe-area-inset-bottom, 0);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 1rem;
        color: var(--color-muted);
        text-decoration: none;
        transition: color 0.2s;
      }

      .nav-item:hover {
        color: var(--color-text-secondary);
      }

      .nav-item.active {
        color: var(--color-primary);
      }

      .nav-item .material-symbols-outlined {
        font-size: 24px;
      }

      /* WhatsApp FAB - Central Elevated Button */
      .nav-fab {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        margin-top: -24px;
        background-color: #25D366;
        border-radius: 50%;
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .nav-fab:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(37, 211, 102, 0.5);
      }

      .nav-fab:active {
        transform: scale(0.95);
      }

      .whatsapp-icon {
        width: 28px;
        height: 28px;
      }
    </style>
  </body>
</html>
